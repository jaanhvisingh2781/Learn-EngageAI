{% extends "base.html" %}

{% block title %}Support Tickets - LearnEngage AI{% endblock %}

{% block page_title %}Support Tickets{% endblock %}
{% block page_subtitle %}Manage and resolve learner support requests{% endblock %}

{% block content %}
<!-- Ticket Filters -->
<div class="ticket-filters card" style="margin-bottom: 20px;">
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <div style="position: relative; flex: 1;">
            <input type="text" id="ticketSearch" placeholder="Search tickets..." style="width: 100%; padding: 10px 15px 10px 40px; border: 1px solid var(--light-gray); border-radius: 8px; font-size: 14px;">
            <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gray);"></i>
        </div>
        <select id="statusFilter" style="padding: 10px 15px; border: 1px solid var(--light-gray); border-radius: 8px; font-size: 14px; min-width: 150px;">
            <option value="">All Status</option>
            <option value="open">Open</option>
            <option value="pending">Pending</option>
            <option value="resolved">Resolved</option>
            <option value="closed">Closed</option>
        </select>
        <select id="priorityFilter" style="padding: 10px 15px; border: 1px solid var(--light-gray); border-radius: 8px; font-size: 14px; min-width: 150px;">
            <option value="">All Priority</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
        </select>
        <button class="btn btn-primary" onclick="createNewTicket()">
            <i class="fas fa-plus"></i> New Ticket
        </button>
    </div>
</div>

<!-- Ticket Stats -->
<div class="ticket-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
    <div class="card">
        <div class="stat-icon" style="background-color: rgba(67, 97, 238, 0.1); color: #4361ee; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 20px;">
            <i class="fas fa-ticket-alt"></i>
        </div>
        <div class="stat-value" id="total-tickets" style="font-size: 24px; font-weight: 600; margin: 5px 0;">0</div>
        <div class="stat-label" style="color: var(--gray); font-size: 14px;">Total Tickets</div>
    </div>
    <div class="card">
        <div class="stat-icon" style="background-color: rgba(231, 76, 60, 0.1); color: #e74c3c; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 20px;">
            <i class="fas fa-exclamation-circle"></i>
        </div>
        <div class="stat-value" id="open-tickets" style="font-size: 24px; font-weight: 600; margin: 5px 0;">0</div>
        <div class="stat-label" style="color: var(--gray); font-size: 14px;">Open Tickets</div>
    </div>
    <div class="card">
        <div class="stat-icon" style="background-color: rgba(243, 156, 18, 0.1); color: #f39c12; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 20px;">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-value" id="pending-tickets" style="font-size: 24px; font-weight: 600; margin: 5px 0;">0</div>
        <div class="stat-label" style="color: var(--gray); font-size: 14px;">Pending Tickets</div>
    </div>
    <div class="card">
        <div class="stat-icon" style="background-color: rgba(46, 204, 113, 0.1); color: #2ecc71; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 20px;">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-value" id="resolved-tickets" style="font-size: 24px; font-weight: 600; margin: 5px 0;">0</div>
        <div class="stat-label" style="color: var(--gray); font-size: 14px;">Resolved Tickets</div>
    </div>
</div>

<!-- Tickets Table -->
<div class="card">
    <div class="table-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="table-title" style="font-size: 18px; font-weight: 600;">All Tickets</div>
        <button class="btn btn-primary" onclick="loadTickets()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>
    <div class="table-container">
        <table class="ticket-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">ID</th>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Subject</th>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Requester</th>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Status</th>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Priority</th>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Created</th>
                    <th style="padding: 12px 15px; text-align: center; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Actions</th>
                </tr>
            </thead>
            <tbody id="ticketTableBody">
                <tr>
                    <td colspan="7" style="text-align: center; padding: 12px 15px;">Loading tickets...</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="table-footer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        <div class="table-info" style="color: var(--gray); font-size: 14px;">
            Showing <span id="ticketStartIndex">0</span> to <span id="ticketEndIndex">0</span> of <span id="totalTickets">0</span> tickets
        </div>
        <div class="pagination" style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" id="ticketPrevPage" onclick="changeTicketPage(-1)" disabled>
                <i class="fas fa-chevron-left"></i> Previous
            </button>
            <button class="btn btn-secondary" id="ticketNextPage" onclick="changeTicketPage(1)" disabled>
                Next <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- New Ticket Modal -->
<div id="newTicketModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeNewTicketModal()">&times;</span>
        <h2>Create New Ticket</h2>
        <form id="newTicketForm">
            <div class="form-group">
                <label class="form-label">Learner Email</label>
                <input type="email" class="form-input" id="learnerEmail" required>
            </div>
            <div class="form-group">
                <label class="form-label">Subject</label>
                <input type="text" class="form-input" id="ticketSubject" required>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="ticketDescription" required></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Priority</label>
                <select class="form-select" id="ticketPriority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select>
            </div>
            <button type="submit" class="submit-btn">Create Ticket</button>
        </form>
    </div>
</div>

<!-- View Ticket Modal -->
<div id="viewTicketModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeViewTicketModal()">&times;</span>
        <h2 id="viewTicketTitle">Ticket Details</h2>
        <div id="viewTicketContent">
            <!-- Ticket details will be loaded here -->
        </div>
    </div>
</div>

<script>
    // Global variables
    let tickets = [];
    let filteredTickets = [];
    let currentTicketPage = 1;
    const ticketsPerPage = 10;

    // DOM Content Loaded
    document.addEventListener('DOMContentLoaded', function() {
        loadTickets();
        
        // Add event listeners for search and filters
        document.getElementById('ticketSearch').addEventListener('input', filterTickets);
        document.getElementById('statusFilter').addEventListener('change', filterTickets);
        document.getElementById('priorityFilter').addEventListener('change', filterTickets);
        
        // Set up new ticket form
        document.getElementById('newTicketForm').addEventListener('submit', createNewTicket);
    });

    // Function to load tickets
    async function loadTickets() {
        try {
            const response = await fetch('/api/tickets');
            tickets = await response.json();
            calculateTicketStats(); // Calculate stats after loading tickets
            filterTickets();
        } catch (error) {
            console.error('Error loading tickets:', error);
        }
    }

    // Function to calculate ticket stats from loaded data
    function calculateTicketStats() {
        if (!tickets || tickets.length === 0) {
            document.getElementById('total-tickets').textContent = '0';
            document.getElementById('open-tickets').textContent = '0';
            document.getElementById('pending-tickets').textContent = '0';
            document.getElementById('resolved-tickets').textContent = '0';
            return;
        }
        
        const totalTickets = tickets.length;
        let openTickets = 0;
        let pendingTickets = 0;
        let resolvedTickets = 0;
        
        tickets.forEach(ticket => {
            const status = ticket.status.toLowerCase();
            if (status === 'open') {
                openTickets++;
            } else if (status === 'in progress') {
                pendingTickets++;
            } else if (status === 'resolved' || status === 'closed') {
                resolvedTickets++;
            }
        });
        
        document.getElementById('total-tickets').textContent = totalTickets.toLocaleString();
        document.getElementById('open-tickets').textContent = openTickets.toLocaleString();
        document.getElementById('pending-tickets').textContent = pendingTickets.toLocaleString();
        document.getElementById('resolved-tickets').textContent = resolvedTickets.toLocaleString();
    }

    // Function to filter tickets
    function filterTickets() {
        const searchTerm = document.getElementById('ticketSearch').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const priorityFilter = document.getElementById('priorityFilter').value;
        
        filteredTickets = tickets.filter(ticket => {
            // Search filter
            const matchesSearch = ticket.subject.toLowerCase().includes(searchTerm) || 
                                 ticket.requester_name.toLowerCase().includes(searchTerm) ||
                                 (ticket.description && ticket.description.toLowerCase().includes(searchTerm));
            
            // Status filter
            const matchesStatus = !statusFilter || ticket.status === statusFilter;
            
            // Priority filter
            const matchesPriority = !priorityFilter || ticket.priority === priorityFilter;
            
            return matchesSearch && matchesStatus && matchesPriority;
        });
        
        currentTicketPage = 1;
        displayTickets();
        updateTicketPagination();
    }

    // Function to display tickets
    function displayTickets() {
        const tbody = document.getElementById('ticketTableBody');
        tbody.innerHTML = '';
        
        if (filteredTickets.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center;">No tickets found</td>
                </tr>
            `;
            return;
        }
        
        // Calculate start and end index for current page
        const startIndex = (currentTicketPage - 1) * ticketsPerPage;
        const endIndex = Math.min(startIndex + ticketsPerPage, filteredTickets.length);
        
        // Update pagination info
        document.getElementById('ticketStartIndex').textContent = startIndex + 1;
        document.getElementById('ticketEndIndex').textContent = endIndex;
        document.getElementById('totalTickets').textContent = filteredTickets.length;
        
        // Display tickets for current page
        for (let i = startIndex; i < endIndex; i++) {
            const ticket = filteredTickets[i];
            const row = document.createElement('tr');
            
            // Determine status and priority classes
            const statusClass = `status-${ticket.status}`;
            const priorityClass = `priority-${ticket.priority}`;
            
            // Format created date
            const createdDate = formatDate(ticket.created_at);
            
            // Shorten subject if too long
            const shortSubject = ticket.subject.length > 50 ? 
                ticket.subject.substring(0, 50) + '...' : ticket.subject;
            
            row.innerHTML = `
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);">${ticket.ticket_id}</td>
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);" title="${ticket.subject}">${shortSubject}</td>
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);">${ticket.requester_name}</td>
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);"><span class="status-badge ${statusClass}">${ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1)}</span></td>
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);" class="${priorityClass}">${ticket.priority.charAt(0).toUpperCase() + ticket.priority.slice(1)}</td>
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);">${createdDate}</td>
                <td style="padding: 12px 15px; text-align: center; border-bottom: 1px solid var(--light-gray);">
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn-icon" onclick="viewTicket('${ticket.ticket_id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${ticket.status === 'open' || ticket.status === 'pending' ? 
                            `<button class="btn-icon" onclick="resolveTicket('${ticket.ticket_id}')" title="Resolve Ticket">
                                <i class="fas fa-check"></i>
                            </button>` : 
                            ''
                        }
                        <button class="btn-icon" onclick="deleteTicket('${ticket.ticket_id}')" title="Delete Ticket">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        }
    }

    // Function to update ticket pagination
    function updateTicketPagination() {
        const totalPages = Math.ceil(filteredTickets.length / ticketsPerPage);
        const prevButton = document.getElementById('ticketPrevPage');
        const nextButton = document.getElementById('ticketNextPage');
        
        prevButton.disabled = currentTicketPage <= 1;
        nextButton.disabled = currentTicketPage >= totalPages;
    }

    // Function to change ticket page
    function changeTicketPage(direction) {
        const totalPages = Math.ceil(filteredTickets.length / ticketsPerPage);
        currentTicketPage += direction;
        
        if (currentTicketPage < 1) currentTicketPage = 1;
        if (currentTicketPage > totalPages) currentTicketPage = totalPages;
        
        displayTickets();
        updateTicketPagination();
    }

    // Function to format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString();
    }

    // Modal functions
    function createNewTicket() {
        document.getElementById('newTicketModal').style.display = 'block';
    }

    function closeNewTicketModal() {
        document.getElementById('newTicketModal').style.display = 'none';
        document.getElementById('newTicketForm').reset();
    }

    function closeViewTicketModal() {
        document.getElementById('viewTicketModal').style.display = 'none';
    }

    // Function to create a new ticket
    async function createNewTicket(e) {
        e.preventDefault();
        
        const learnerEmail = document.getElementById('learnerEmail').value;
        const subject = document.getElementById('ticketSubject').value;
        const description = document.getElementById('ticketDescription').value;
        const priority = document.getElementById('ticketPriority').value;
        
        try {
            const response = await fetch('/api/tickets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    learner_email: learnerEmail,
                    subject: subject,
                    description: description,
                    priority: priority
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Ticket created successfully!');
                closeNewTicketModal();
                loadTickets(); // Refresh the tickets list
                loadTicketStats(); // Refresh stats
            } else {
                alert('Error creating ticket: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error creating ticket');
        }
    }

    // Function to view ticket details
    async function viewTicket(ticketId) {
        try {
            const response = await fetch(`/api/tickets/${ticketId}`);
            const ticket = await response.json();
            
            document.getElementById('viewTicketTitle').textContent = `Ticket #${ticket.ticket_id}`;
            
            const ticketContent = `
                <div class="ticket-details">
                    <div class="form-group">
                        <label class="form-label">Requester</label>
                        <p>${ticket.requester_name} (${ticket.requester_email})</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subject</label>
                        <p>${ticket.subject}</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <p>${ticket.description}</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <p>${ticket.priority}</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <p>${ticket.status}</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Created</label>
                        <p>${new Date(ticket.created_at).toLocaleString()}</p>
                    </div>
                    ${ticket.resolved_at ? `
                        <div class="form-group">
                            <label class="form-label">Resolved</label>
                            <p>${new Date(ticket.resolved_at).toLocaleString()}</p>
                        </div>
                    ` : ''}
                    ${ticket.feedback ? `
                        <div class="form-group">
                            <label class="form-label">Feedback</label>
                            <p>${ticket.feedback}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('viewTicketContent').innerHTML = ticketContent;
            document.getElementById('viewTicketModal').style.display = 'block';
        } catch (error) {
            console.error('Error loading ticket details:', error);
            alert('Error loading ticket details');
        }
    }

    // Function to resolve a ticket
    async function resolveTicket(ticketId) {
        const feedback = prompt('Please enter resolution notes:');
        
        if (feedback === null) return; // User cancelled
        
        try {
            const response = await fetch(`/api/tickets/${ticketId}/resolve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    feedback: feedback
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Ticket resolved successfully!');
                loadTickets(); // Refresh the tickets list
                loadTicketStats(); // Refresh stats
            } else {
                alert('Error resolving ticket: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error resolving ticket');
        }
    }

    // Function to delete a ticket
    async function deleteTicket(ticketId) {
        if (!confirm('Are you sure you want to delete this ticket?')) return;
        
        try {
            const response = await fetch(`/api/tickets/${ticketId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Ticket deleted successfully!');
                loadTickets(); // Refresh the tickets list
                loadTicketStats(); // Refresh stats
            } else {
                alert('Error deleting ticket: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting ticket');
        }
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        const newTicketModal = document.getElementById('newTicketModal');
        const viewTicketModal = document.getElementById('viewTicketModal');
        
        if (event.target === newTicketModal) {
            closeNewTicketModal();
        }
        if (event.target === viewTicketModal) {
            closeViewTicketModal();
        }
    }
</script>

<style>
    .status-open {
        color: #e74c3c;
        font-weight: 600;
    }
    
    .status-pending {
        color: #f39c12;
        font-weight: 600;
    }
    
    .status-resolved {
        color: #2ecc71;
        font-weight: 600;
    }
    
    .status-closed {
        color: #7f8c8d;
        font-weight: 600;
    }
    
    .priority-low {
        color: #2ecc71;
        font-weight: 600;
    }
    
    .priority-medium {
        color: #f39c12;
        font-weight: 600;
    }
    
    .priority-high {
        color: #e74c3c;
        font-weight: 600;
    }
    
    .priority-urgent {
        color: #9b59b6;
        font-weight: 600;
    }
    
    .btn-icon {
        background: none;
        border: none;
        color: var(--gray);
        cursor: pointer;
        font-size: 16px;
        padding: 5px;
        border-radius: 4px;
    }
    
    .btn-icon:hover {
        background-color: var(--light);
        color: var(--dark);
    }
    
    @media (max-width: 1200px) {
        .ticket-stats {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .ticket-stats {
            grid-template-columns: 1fr;
        }
        
        .ticket-table {
            font-size: 14px;
        }
        
        .ticket-table th,
        .ticket-table td {
            padding: 8px 10px;
        }
    }
</style>
{% endblock %}