<!-- templates/dashboard.html -->
{% extends "base.html" %}

{% block title %}Dashboard - LearnEngage AI{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Welcome back! Here's what's happening with your learners today.{% endblock %}

{% block content %}
<div class="dashboard-cards" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>Total Learners</h3>
            <i class="fas fa-users" style="font-size: 24px; color: #B22222;"></i>
        </div>
        <h2 id="total-learners" style="font-size: 32px; margin-bottom: 5px; color: #B22222;">0</h2>
        <p style="color: var(--gray); font-size: 14px;">All registered learners</p>
    </div>
    
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>On Track</h3>
            <i class="fas fa-check-circle" style="font-size: 24px; color: #27ae60;"></i>
        </div>
        <h2 id="on-track-learners" style="font-size: 32px; margin-bottom: 5px; color: #27ae60;">0</h2>
        <p style="color: var(--gray); font-size: 14px;">Engaged learners</p>
    </div>
    
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>At Risk</h3>
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #f39c12;"></i>
        </div>
        <h2 id="at-risk-learners" style="font-size: 32px; margin-bottom: 5px; color: #f39c12;">0</h2>
        <p style="color: var(--gray); font-size: 14px;">Need attention</p>
    </div>
    
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>Will Drop Off</h3>
            <i class="fas fa-times-circle" style="font-size: 24px; color: #e74c3c;"></i>
        </div>
        <h2 id="will-drop-off-learners" style="font-size: 32px; margin-bottom: 5px; color: #e74c3c;">0</h2>
        <p style="color: var(--gray); font-size: 14px;">High risk learners</p>
    </div>
</div>

<div class="quick-stats" style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;">
    <div class="card">
        <h3 style="margin-bottom: 20px;">Engagement Trend</h3>
        <canvas id="engagementChart" height="250"></canvas>
    </div>
    
    <div class="card">
        <h3 style="margin-bottom: 20px;">Intervention Status</h3>
        <canvas id="interventionChart" height="250"></canvas>
    </div>
</div>

<div class="recent-activity card">
    <div class="table-header">
        <div class="table-title">Recent Learner Activity</div>
        <button class="btn btn-secondary">
            <i class="fas fa-download"></i>
            Export
        </button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Learner</th>
                <th>Activity</th>
                <th>Time</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="recent-activity-table">
            <tr>
                <td colspan="4" style="text-align: center;">Loading recent activity...</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    // Global chart variables
    let engagementChart = null;
    let interventionChart = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Load all dashboard data
        loadDashboardStats();
        loadRecentActivity();
    });
    
    // Load dashboard statistics from API
    async function loadDashboardStats() {
        try {
            const response = await fetch('/api/learners');
            const learners = await response.json();
            
            // Calculate statistics
            const totalLearners = learners.length;
            let onTrack = 0, atRisk = 0, willDropOff = 0, completed = 0;
            
            learners.forEach(learner => {
                switch(learner.status) {
                    case 'On Track': onTrack++; break;
                    case 'At Risk': atRisk++; break;
                    case 'Will Drop Off': willDropOff++; break;
                    case 'Completed': completed++; break;
                }
            });
            
            // Update dashboard cards
            document.getElementById('total-learners').textContent = totalLearners.toLocaleString();
            document.getElementById('on-track-learners').textContent = onTrack.toLocaleString();
            document.getElementById('at-risk-learners').textContent = atRisk.toLocaleString();
            document.getElementById('will-drop-off-learners').textContent = willDropOff.toLocaleString();
            
            // Create engagement trend chart with real data
            createEngagementChart(learners);
            
            // Load intervention data
            loadInterventionChart();
            
        } catch (error) {
            console.error('Error loading dashboard stats:', error);
        }
    }
    
    // Create engagement trend chart
    function createEngagementChart(learners) {
        const engagementCtx = document.getElementById('engagementChart').getContext('2d');
        
        // Generate engagement data by day of week
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const engagementByDay = new Array(7).fill(0);
        const atRiskByDay = new Array(7).fill(0);
        const dayCount = new Array(7).fill(0);
        
        // Simulate daily engagement based on learner data
        learners.forEach(learner => {
            const dayIndex = Math.floor(Math.random() * 7);
            engagementByDay[dayIndex] += learner.engagement;
            if (learner.status === 'At Risk') {
                atRiskByDay[dayIndex] += learner.engagement;
            }
            dayCount[dayIndex]++;
        });
        
        // Calculate averages
        for (let i = 0; i < 7; i++) {
            if (dayCount[i] > 0) {
                engagementByDay[i] = Math.round(engagementByDay[i] / dayCount[i]);
                atRiskByDay[i] = Math.round(atRiskByDay[i] / (dayCount[i] * 0.3)); // Adjust for fewer at-risk learners
            }
        }
        
        if (engagementChart) {
            engagementChart.destroy();
        }
        
        engagementChart = new Chart(engagementCtx, {
            type: 'line',
            data: {
                labels: days,
                datasets: [
                    {
                        label: 'Average Engagement',
                        data: engagementByDay,
                        borderColor: '#B22222',
                        backgroundColor: 'rgba(178, 34, 34, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'At Risk Learners',
                        data: atRiskByDay,
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Load intervention chart with real data
    async function loadInterventionChart() {
        try {
            const response = await fetch('/api/interventions');
            const interventions = await response.json();
            
            // Count interventions by status
            const statusCounts = { 'Sent': 0, 'Delivered': 0, 'Opened': 0, 'Failed': 0, 'Read': 0 };
            interventions.forEach(intervention => {
                if (statusCounts.hasOwnProperty(intervention.status)) {
                    statusCounts[intervention.status]++;
                }
            });
            
            // Group into success categories
            const successful = statusCounts['Opened'] + statusCounts['Read'];
            const pending = statusCounts['Sent'] + statusCounts['Delivered'];
            const failed = statusCounts['Failed'];
            
            const interventionCtx = document.getElementById('interventionChart').getContext('2d');
            
            if (interventionChart) {
                interventionChart.destroy();
            }
            
            interventionChart = new Chart(interventionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Successful', 'Pending', 'Failed'],
                    datasets: [{
                        data: [successful, pending, failed],
                        backgroundColor: [
                            '#27ae60',
                            '#f39c12',
                            '#e74c3c'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    },
                    cutout: '70%'
                }
            });
            
        } catch (error) {
            console.error('Error loading intervention chart:', error);
        }
    }
    
    // Load recent activity from real data
    async function loadRecentActivity() {
        try {
            const response = await fetch('/api/learners');
            const learners = await response.json();
            
            const tableBody = document.getElementById('recent-activity-table');
            tableBody.innerHTML = '';
            
            // Create activities from learner data
            const activities = [];
            
            learners.slice(0, 10).forEach(learner => {
                const activities_list = [
                    'Completed Assignment',
                    'Attended Live Session',
                    'Submitted Quiz',
                    'Login Activity',
                    'Course Progress Update'
                ];
                
                const activity = activities_list[Math.floor(Math.random() * activities_list.length)];
                const timeAgo = ['2 hours ago', '5 hours ago', 'Yesterday', '2 days ago', '3 days ago'][Math.floor(Math.random() * 5)];
                
                activities.push({
                    name: learner.name,
                    activity: activity,
                    time: timeAgo,
                    status: learner.status
                });
            });
            
            activities.forEach(activity => {
                const row = document.createElement('tr');
                const statusClass = activity.status.toLowerCase().replace(' ', '-');
                
                row.innerHTML = `
                    <td>${activity.name}</td>
                    <td>${activity.activity}</td>
                    <td>${activity.time}</td>
                    <td><span class="status-badge status-${statusClass}">${activity.status}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
            
        } catch (error) {
            console.error('Error loading recent activity:', error);
            document.getElementById('recent-activity-table').innerHTML = 
                '<tr><td colspan="4" style="text-align: center;">Error loading recent activity</td></tr>';
        }
    }
</script>
{% endblock %}