<!-- templates/dashboard.html -->
{% extends "base.html" %}

{% block title %}Dashboard - LearnEngage AI{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Welcome back! Here's what's happening with your learners today.{% endblock %}

{% block content %}
<div class="dashboard-cards">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>Total Learners</h3>
            <i class="fas fa-users" style="font-size: 24px; color: #B22222;"></i>
        </div>
        <h2 id="total-learners" style="font-size: 32px; margin-bottom: 5px; color: #B22222;">0</h2>
        <p style="color: var(--gray); font-size: 14px;">All registered learners</p>
    </div>
    
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3><span class="status-badge status-on-track">On Track</span></h3>
            <i class="fas fa-check-circle" style="font-size: 24px; color: #27ae60;"></i>
        </div>
        <h2 id="on-track-learners" style="font-size: 32px; margin-bottom: 5px; color: #27ae60;">0</h2>
        <p style="color: var(--gray); font-size: 14px;">Engaged learners</p>
    </div>
    
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>At Risk</h3>
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #f39c12;"></i>
        </div>
        <h2 id="at-risk-learners" style="font-size: 32px; margin-bottom: 5px; color: #f39c12;">0</h2>
        <p style="color: var(--gray); font-size: 14px;">Need attention</p>
    </div>
    
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>Completed</h3>
            <i class="fas fa-graduation-cap" style="font-size: 24px; color: #9b59b6;"></i>
        </div>
        <h2 id="completed-learners" style="font-size: 32px; margin-bottom: 5px; color: #9b59b6;">0</h2>
        <p style="color: var(--gray); font-size: 14px;">Finished their program</p>
    </div>
    
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3><span class="status-badge status-will-drop-off">Will Drop Off</span></h3>
            <i class="fas fa-times-circle" style="font-size: 24px; color: #e74c3c;"></i>
        </div>
        <h2 id="will-drop-off-learners" style="font-size: 32px; margin-bottom: 5px; color: #e74c3c;">0</h2>
        <p style="color: var(--gray); font-size: 14px;">High risk learners</p>
    </div>
</div>

<div class="quick-stats">
    <div class="card" style="height: 350px; max-width: 100%; min-width: 0; display: flex; flex-direction: column;">
        <h3 style="margin-bottom: 20px;">Monthly Engagement Trend</h3>
        <div style="flex: 1; min-height: 0; display: flex; align-items: center; justify-content: center;">
            <canvas id="engagementChart" style="max-width: 100%; max-height: 250px; width: 100% !important; height: 250px !important;"></canvas>
        </div>
    </div>
    
    <div class="card">
        <h3 style="margin-bottom: 20px;">Intervention Status</h3>
        <canvas id="interventionChart" height="250"></canvas>
    </div>
</div>

<div class="recent-activity card">
    <div class="table-header">
        <div class="table-title">Recent Learner Activity</div>
        <button class="btn btn-secondary">
            <i class="fas fa-download"></i>
            Export
        </button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Learner</th>
                <th>Activity</th>
                <th>Time</th>
                <th style="width: 150px;">Status</th>
            </tr>
        </thead>
        <tbody id="recent-activity-table">
            <tr>
                <td colspan="4" style="text-align: center;">Loading recent activity...</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    // Global chart variables
    let engagementChart = null;
    let interventionChart = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Load all dashboard data
        loadDashboardStats();
        loadRecentActivity();
    });
    
    // Load dashboard statistics from API
    async function loadDashboardStats() {
        try {
            const response = await fetch('/api/dashboard-stats');
            const stats = await response.json();
            
            // Update dashboard cards from backend-determined counts
            document.getElementById('total-learners').textContent = (stats.total_learners || 0).toLocaleString();
            document.getElementById('on-track-learners').textContent = (stats.on_track || 0).toLocaleString();
            document.getElementById('at-risk-learners').textContent = (stats.at_risk || 0).toLocaleString();
            document.getElementById('completed-learners').textContent = (stats.completed || 0).toLocaleString();
            document.getElementById('will-drop-off-learners').textContent = (stats.will_drop || 0).toLocaleString();
            
            // Create engagement trend chart (independent fetch)
            createEngagementChart();
            
            // Load intervention data
            loadInterventionChart();
            
        } catch (error) {
            console.error('Error loading dashboard stats:', error);
        }
    }
    
    // Create engagement trend chart with monthly data
    async function createEngagementChart(learners) {
        try {
            const response = await fetch('/api/monthly-engagement');
            const monthlyData = await response.json();
            
            const engagementCtx = document.getElementById('engagementChart').getContext('2d');
            
            if (engagementChart) {
                engagementChart.destroy();
            }
            
            engagementChart = new Chart(engagementCtx, {
                type: 'line',
                data: {
                    labels: monthlyData.labels,
                    datasets: [
                        {
                            label: 'Average Engagement',
                            data: monthlyData.engagement_data,
                            borderColor: '#B22222',
                            backgroundColor: 'rgba(178, 34, 34, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointBackgroundColor: '#B22222',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        },
                        {
                            label: 'At Risk Engagement',
                            data: monthlyData.at_risk_data,
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2,
                            pointBackgroundColor: '#f39c12',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
            
        } catch (error) {
            console.error('Error loading monthly engagement chart:', error);
            // Fallback to empty chart
            const engagementCtx = document.getElementById('engagementChart').getContext('2d');
            if (engagementChart) {
                engagementChart.destroy();
            }
            
            engagementChart = new Chart(engagementCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'No Data Available',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#ddd',
                        backgroundColor: 'rgba(221, 221, 221, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    }
    
    // Load intervention chart with real data
    async function loadInterventionChart() {
        try {
            const response = await fetch('/api/interventions');
            const interventions = await response.json();
            
            // Count interventions by status
            const statusCounts = { 'Sent': 0, 'Delivered': 0, 'Opened': 0, 'Failed': 0, 'Read': 0 };
            interventions.forEach(intervention => {
                if (statusCounts.hasOwnProperty(intervention.status)) {
                    statusCounts[intervention.status]++;
                }
            });
            
            // Group into success categories
            const successful = statusCounts['Opened'] + statusCounts['Read'];
            const pending = statusCounts['Sent'] + statusCounts['Delivered'];
            const failed = statusCounts['Failed'];
            
            const interventionCtx = document.getElementById('interventionChart').getContext('2d');
            
            if (interventionChart) {
                interventionChart.destroy();
            }
            
            interventionChart = new Chart(interventionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Successful', 'Pending', 'Failed'],
                    datasets: [{
                        data: [successful, pending, failed],
                        backgroundColor: [
                            '#27ae60',
                            '#f39c12',
                            '#e74c3c'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    },
                    cutout: '70%'
                }
            });
            
        } catch (error) {
            console.error('Error loading intervention chart:', error);
        }
    }
    
    // Load recent activity from real data
    async function loadRecentActivity() {
        try {
            const response = await fetch('/api/learners');
            const learners = await response.json();
            
            const tableBody = document.getElementById('recent-activity-table');
            tableBody.innerHTML = '';
            
            // Create activities from learner data
            const activities = [];
            
            learners.slice(0, 10).forEach(learner => {
                const activities_list = [
                    'Completed Assignment',
                    'Attended Live Session',
                    'Submitted Quiz',
                    'Login Activity',
                    'Course Progress Update'
                ];
                
                const activity = activities_list[Math.floor(Math.random() * activities_list.length)];
                const timeAgo = ['2 hours ago', '5 hours ago', 'Yesterday', '2 days ago', '3 days ago'][Math.floor(Math.random() * 5)];
                
                activities.push({
                    name: learner.name,
                    activity: activity,
                    time: timeAgo,
                    status: learner.status
                });
            });
            
            activities.forEach(activity => {
                const row = document.createElement('tr');
                const statusClass = activity.status.toLowerCase().replace(/ /g, '-');
                
                // Check if status indicates an issue (highlight in red)
                let additionalClass = '';
                if (activity.status.toLowerCase() === 'will drop off') {
                    additionalClass = ' status-will-drop-off';
                } else {
                    const issueKeywords = ['at risk', 'will drop off', 'drop off', 'failed', 'error', 'problem', 'issue', 'concern'];
                    const hasIssue = issueKeywords.some(keyword => activity.status.toLowerCase().includes(keyword));
                    additionalClass = hasIssue ? ' status-issue' : '';
                }
                
                row.innerHTML = `
                    <td>${activity.name}</td>
                    <td>${activity.activity}</td>
                    <td>${activity.time}</td>
                    <td class="status-column"><span class="status-badge status-${statusClass}${additionalClass}">${activity.status}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
            
        } catch (error) {
            console.error('Error loading recent activity:', error);
            document.getElementById('recent-activity-table').innerHTML = 
                '<tr><td colspan="4" style="text-align: center;">Error loading recent activity</td></tr>';
        }
    }
</script>
{% endblock %}