{% extends "base.html" %}

{% block title %}Learners - LearnEngage AI{% endblock %}

{% block page_title %}Learner Management{% endblock %}
{% block page_subtitle %}Manage and monitor learner progress and engagement{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="card">
        <div class="stat-icon" style="background-color: rgba(67, 97, 238, 0.1); color: #4361ee; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 20px;">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-value" id="total-learners" style="font-size: 24px; font-weight: 600; margin: 5px 0;">0</div>
        <div class="stat-label" style="color: var(--gray); font-size: 14px;">Total Learners</div>
    </div>
    <div class="card">
        <div class="stat-icon" style="background-color: rgba(46, 204, 113, 0.1); color: #2ecc71; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 20px;">
            <i class="fas fa-user-check"></i>
        </div>
        <div class="stat-value" id="active-learners" style="font-size: 24px; font-weight: 600; margin: 5px 0;">0</div>
        <div class="stat-label" style="color: var(--gray); font-size: 14px;">Active Learners</div>
    </div>
    <div class="card">
        <div class="stat-icon" style="background-color: rgba(241, 196, 15, 0.1); color: #f1c40f; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 20px;">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-value" id="at-risk-learners" style="font-size: 24px; font-weight: 600; margin: 5px 0;">0</div>
        <div class="stat-label" style="color: var(--gray); font-size: 14px;">At-Risk Learners</div>
    </div>
    <div class="card">
        <div class="stat-icon" style="background-color: rgba(155, 89, 182, 0.1); color: #9b59b6; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 20px;">
            <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="stat-value" id="completed-learners" style="font-size: 24px; font-weight: 600; margin: 5px 0;">0</div>
        <div class="stat-label" style="color: var(--gray); font-size: 14px;">Completed Learners</div>
    </div>
</div>

<!-- Search and Filter -->
<div class="search-filter card" style="margin-bottom: 20px;">
    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
        <div style="position: relative; flex: 1; min-width: 200px;">
            <input type="text" id="learnerSearch" placeholder="Search by name or email..." style="width: 100%; padding: 10px 15px 10px 40px; border: 1px solid var(--light-gray); border-radius: 8px; font-size: 14px;">
            <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gray);"></i>
        </div>
        <select id="courseFilter" style="padding: 10px 15px; border: 1px solid var(--light-gray); border-radius: 8px; font-size: 14px; min-width: 150px;">
            <option value="">All Courses</option>
            {% for course in courses %}
            <option value="{{ course.course_id }}">{{ course.course_name }}</option>
            {% endfor %}
        </select>
        <select id="cohortFilter" style="padding: 10px 15px; border: 1px solid var(--light-gray); border-radius: 8px; font-size: 14px; min-width: 150px;">
            <option value="">All Cohorts</option>
            {% for cohort in cohorts %}
            <option value="{{ cohort.cohort_id }}">{{ cohort.cohort_id }}</option>
            {% endfor %}
        </select>
        <select id="riskFilter" style="padding: 10px 15px; border: 1px solid var(--light-gray); border-radius: 8px; font-size: 14px; min-width: 150px;">
            <option value="">All Risk Levels</option>
            <option value="low">Low Risk</option>
            <option value="medium">Medium Risk</option>
            <option value="high">High Risk</option>
        </select>
        <button class="btn btn-primary" onclick="exportLearnerData()">
            <i class="fas fa-download"></i> Export
        </button>
    </div>
</div>

<!-- Learner Table -->
<div class="card">
    <div class="table-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <div class="table-title" style="font-size: 18px; font-weight: 600;">All Learners</div>
        <button class="btn btn-primary" onclick="loadLearners()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>
    <div class="table-container" style="overflow-x: auto;">
        <table class="learner-table" style="width: 100%; border-collapse: collapse; min-width: 900px;">
            <thead>
                <tr>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Name</th>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Email</th>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Course</th>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Cohort</th>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Engagement</th>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Progress</th>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Status</th>
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Last Active</th>
                    <th style="padding: 12px 15px; text-align: center; border-bottom: 1px solid var(--light-gray); background-color: var(--light); font-weight: 600;">Actions</th>
                </tr>
            </thead>
            <tbody id="learnerTableBody">
                <tr>
                    <td colspan="9" style="text-align: center; padding: 12px 15px;">Loading learners...</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="table-footer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 10px;">
        <div class="table-info" style="color: var(--gray); font-size: 14px;">
            Showing <span id="startIndex">0</span> to <span id="endIndex">0</span> of <span id="totalLearners">0</span> learners
        </div>
        <div class="pagination" style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" id="prevPage" onclick="changePage(-1)" disabled>
                <i class="fas fa-chevron-left"></i> Previous
            </button>
            <button class="btn btn-secondary" id="nextPage" onclick="changePage(1)" disabled>
                Next <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<style>
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-align: center;
    }
    
    .status-on-track {
        background-color: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
        border: 1px solid rgba(46, 204, 113, 0.3);
    }
    
    .status-at-risk {
        background-color: rgba(241, 196, 15, 0.1);
        color: #f1c40f;
        border: 1px solid rgba(241, 196, 15, 0.3);
    }
    
    .status-will-drop-off {
        background-color: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
        border: 1px solid rgba(231, 76, 60, 0.3);
    }
    
    .status-completed {
        background-color: rgba(155, 89, 182, 0.1);
        color: #9b59b6;
        border: 1px solid rgba(155, 89, 182, 0.3);
    }
</style>

<script>
    // Global variables
    let learners = [];
    let filteredLearners = [];
    let currentPage = 1;
    const learnersPerPage = 10;

    // DOM Content Loaded
    document.addEventListener('DOMContentLoaded', function() {
        loadLearners();
        
        // Add event listeners for search and filters
        document.getElementById('learnerSearch').addEventListener('input', filterLearners);
        document.getElementById('courseFilter').addEventListener('change', filterLearners);
        document.getElementById('cohortFilter').addEventListener('change', filterLearners);
        document.getElementById('riskFilter').addEventListener('change', filterLearners);
    });

    // Function to load learners
    async function loadLearners() {
        try {
            showLoader('learnerTableBody', 'Loading learners...');
            const response = await fetch('/api/learners');
            learners = await response.json();
            calculateLearnerStats(); // Calculate stats after loading learners
            filterLearners();
        } catch (error) {
            console.error('Error loading learners:', error);
            showError('learnerTableBody', 'Error loading learners. Please try again.');
        }
    }

    // Function to calculate learner stats from loaded data
    function calculateLearnerStats() {
        if (!learners || learners.length === 0) {
            // Set all stats to 0 if no learners
            document.getElementById('total-learners').textContent = '0';
            document.getElementById('active-learners').textContent = '0';
            document.getElementById('at-risk-learners').textContent = '0';
            document.getElementById('completed-learners').textContent = '0';
            return;
        }
        
        const totalLearners = learners.length;
        let activeLearners = 0;
        let atRiskLearners = 0;
        let completedLearners = 0;
        
        learners.forEach(learner => {
            // Count by status
            if (learner.status === 'On Track') {
                activeLearners++;
            } else if (learner.status === 'At Risk') {
                atRiskLearners++;
            } else if (learner.status === 'Completed') {
                completedLearners++;
            }
            // Note: 'Will Drop Off' learners are not counted as active, at-risk, or completed
        });
        
        // Update the display
        document.getElementById('total-learners').textContent = totalLearners.toLocaleString();
        document.getElementById('active-learners').textContent = activeLearners.toLocaleString();
        document.getElementById('at-risk-learners').textContent = atRiskLearners.toLocaleString();
        document.getElementById('completed-learners').textContent = completedLearners.toLocaleString();
    }

    // Function to filter learners
    function filterLearners() {
        const searchTerm = document.getElementById('learnerSearch').value.toLowerCase();
        const courseFilter = document.getElementById('courseFilter').value;
        const cohortFilter = document.getElementById('cohortFilter').value;
        const riskFilter = document.getElementById('riskFilter').value;
        
        filteredLearners = learners.filter(learner => {
            // Search filter
            const matchesSearch = learner.name.toLowerCase().includes(searchTerm) || 
                                 learner.email.toLowerCase().includes(searchTerm);
            
            // Course filter
            const matchesCourse = !courseFilter || learner.course_id === courseFilter;
            
            // Cohort filter
            const matchesCohort = !cohortFilter || learner.cohort === cohortFilter;
            
            // Risk filter
            const matchesRisk = !riskFilter || learner.risk_level === riskFilter;
            
            return matchesSearch && matchesCourse && matchesCohort && matchesRisk;
        });
        
        currentPage = 1;
        displayLearners();
        updatePagination();
    }

    // Function to display learners
    function displayLearners() {
        const tbody = document.getElementById('learnerTableBody');
        tbody.innerHTML = '';
        
        if (filteredLearners.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center;">No learners found matching your criteria</td>
                </tr>
            `;
            return;
        }
        
        // Calculate start and end index for current page
        const startIndex = (currentPage - 1) * learnersPerPage;
        const endIndex = Math.min(startIndex + learnersPerPage, filteredLearners.length);
        
        // Update pagination info
        document.getElementById('startIndex').textContent = startIndex + 1;
        document.getElementById('endIndex').textContent = endIndex;
        document.getElementById('totalLearners').textContent = filteredLearners.length;
        
        // Display learners for current page
        for (let i = startIndex; i < endIndex; i++) {
            const learner = filteredLearners[i];
            const row = document.createElement('tr');
            
            // Determine risk level class
            let riskClass = '';
            if (learner.risk_level === 'low') riskClass = 'risk-low';
            else if (learner.risk_level === 'medium') riskClass = 'risk-medium';
            else if (learner.risk_level === 'high') riskClass = 'risk-high';
            
            // Format last active date
            const lastActive = formatDate(learner.last_active);
            
            row.innerHTML = `
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);">
                    <div style="display: flex; align-items: center;">
                        <div class="learner-avatar" style="width: 40px; height: 40px; border-radius: 50%; background-color: #4361ee; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 10px;">
                            ${learner.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div style="font-weight: 600;">${learner.name}</div>
                        </div>
                    </div>
                </td>
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);">${learner.email}</td>
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);">${learner.course_name || 'N/A'}</td>
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);">${learner.cohort}</td>
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);">
                    <div class="engagement-bar" style="width: 100%; height: 8px; background-color: var(--light-gray); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${learner.engagement}%; height: 100%; background-color: #4361ee; border-radius: 4px;"></div>
                    </div>
                    <div style="font-size: 12px; margin-top: 5px;">${learner.engagement}%</div>
                </td>
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);">
                    <div class="progress-bar" style="width: 100%; height: 8px; background-color: var(--light-gray); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${learner.progress}%; height: 100%; background-color: #2ecc71; border-radius: 4px;"></div>
                    </div>
                    <div style="font-size: 12px; margin-top: 5px;">${learner.progress}%</div>
                </td>
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);" class="status-${learner.status.toLowerCase().replace(' ', '-')}">
                    <span class="status-badge status-${learner.status.toLowerCase().replace(' ', '-')}" style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                        ${learner.status}
                    </span>
                </td>
                <td style="padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray);">${lastActive}</td>
                <td style="padding: 12px 15px; text-align: center; border-bottom: 1px solid var(--light-gray);">
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn-icon" onclick="viewLearner('${learner.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" onclick="messageLearner('${learner.id}')" title="Send Message">
                            <i class="fas fa-envelope"></i>
                        </button>
                        <button class="btn-icon" onclick="editLearner('${learner.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        }
    }

    // Function to update pagination
    function updatePagination() {
        const totalPages = Math.ceil(filteredLearners.length / learnersPerPage);
        const prevButton = document.getElementById('prevPage');
        const nextButton = document.getElementById('nextPage');
        
        prevButton.disabled = currentPage <= 1;
        nextButton.disabled = currentPage >= totalPages;
    }

    // Function to change page
    function changePage(direction) {
        const totalPages = Math.ceil(filteredLearners.length / learnersPerPage);
        currentPage += direction;
        
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        
        displayLearners();
        updatePagination();
    }

    // Function to format date
    function formatDate(dateString) {
        if (!dateString || dateString === 'Never') return 'Never';
        
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString();
        } catch (e) {
            return dateString;
        }
    }

    // Function to export learner data
    function exportLearnerData() {
        alert('Learner data export feature will be implemented here.');
    }

    // Function to view learner details
    function viewLearner(learnerId) {
        window.location.href = `/learner/${learnerId}`;
    }

    // Function to message learner
    function messageLearner(learnerId) {
        alert(`Send message to learner ID: ${learnerId}`);
    }

    // Function to edit learner
    function editLearner(learnerId) {
        alert(`Edit learner ID: ${learnerId}`);
    }

    // Helper function to show loader
    function showLoader(elementId, message = 'Loading...') {
        const element = document.getElementById(elementId);
        if (element) {
            element.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 20px;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                            <div class="spinner"></div>
                            <div>${message}</div>
                        </div>
                    </td>
                </tr>
            `;
        }
    }

    // Helper function to show error
    function showError(elementId, message = 'Error loading data') {
        const element = document.getElementById(elementId);
        if (element) {
            element.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 20px; color: #e74c3c;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                            <i class="fas fa-exclamation-circle" style="font-size: 24px;"></i>
                            <div>${message}</div>
                            <button class="btn btn-secondary" onclick="location.reload()">
                                <i class="fas fa-redo"></i> Try Again
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
    }
</script>

<style>
    .risk-low {
        color: #2ecc71;
        font-weight: 600;
    }
    
    .risk-medium {
        color: #f39c12;
        font-weight: 600;
    }
    
    .risk-high {
        color: #e74c3c;
        font-weight: 600;
    }
    
    .btn-icon {
        background: none;
        border: none;
        color: var(--gray);
        cursor: pointer;
        font-size: 16px;
        padding: 5px;
        border-radius: 4px;
    }
    
    .btn-icon:hover {
        background-color: var(--light);
        color: var(--dark);
    }
    
    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .search-filter > div {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-filter > div > * {
            width: 100%;
        }
        
        .table-header, .table-footer {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }
        
        .pagination {
            justify-content: center;
        }
        
        .learner-table {
            font-size: 14px;
        }
        
        .learner-table th,
        .learner-table td {
            padding: 8px 10px;
        }
        
        .learner-avatar {
            width: 30px !important;
            height: 30px !important;
            font-size: 12px !important;
            margin-right: 8px !important;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .learner-table {
            font-size: 12px;
        }
        
        .learner-table th,
        .learner-table td {
            padding: 6px 8px;
        }
    }
</style>
{% endblock %}